import React, { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { 
  getAuth, 
  signInWithEmailAndPassword, 
  onAuthStateChanged, 
  signOut,
  updatePassword 
} from 'firebase/auth';
import { 
  query, 
  where, 
  getDocs, 
  collection,
  updateDoc,
  doc 
} from 'firebase/firestore';
import { db } from '../../utils/firebase';
import { registrarLog } from '../../utils/logUtils';
import './reg-login.css';

function RegLogin({ setUserRole }) {
  const navigate = useNavigate();
  const auth = getAuth();
  
  // Estados de navegaci√≥n
  const [showLogin, setShowLogin] = useState(false);
  
  // Estados del formulario de login
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [initialLoading, setInitialLoading] = useState(true);
  const [loginLoading, setLoginLoading] = useState(false);
  
  // üîê Estados para cambio obligatorio de contrase√±a
  const [showPasswordChangeModal, setShowPasswordChangeModal] = useState(false);
  const [usuarioActual, setUsuarioActual] = useState(null);
  const [nuevaPassword, setNuevaPassword] = useState('');
  const [confirmarPassword, setConfirmarPassword] = useState('');
  const [changingPassword, setChangingPassword] = useState(false);

  useEffect(() => {
    const unsubscribe = onAuthStateChanged(auth, async (user) => {
      if (user) {
        console.log("üîê Usuario detectado en sesi√≥n:", user.email);

        // üîê VERIFICAR SI REQUIERE CAMBIO DE CONTRASE√ëA
        await verificarCambioObligatorio(user);
      } else {
        console.log("‚ùå No hay usuario autenticado.");
        setInitialLoading(false);
      }
    });

    return () => unsubscribe();
  }, [auth]);

  // üîê FUNCI√ìN PARA VERIFICAR CAMBIO OBLIGATORIO DE CONTRASE√ëA
  const verificarCambioObligatorio = async (user) => {
    try {
      const q = query(collection(db, 'usuarios'), where('email', '==', user.email));
      const querySnapshot = await getDocs(q);

      if (!querySnapshot.empty) {
        const userDoc = querySnapshot.docs[0];
        const userData = userDoc.data();
        console.log('üîç Verificando datos de usuario:', userData);

        // üîê VERIFICAR SI REQUIERE CAMBIO DE CONTRASE√ëA
        if (userData.requiereCambioPassword) {
          console.log('üîê Usuario requiere cambio de contrase√±a obligatorio');
          
          // Verificar tiempo desde creaci√≥n para evitar modal inmediato
          const tiempoCreacion = new Date(userData.fechaCreacion).getTime();
          const tiempoActual = new Date().getTime();
          const diferenciaTiempo = tiempoActual - tiempoCreacion;
          
          // Solo mostrar modal si han pasado al menos 10 segundos
          if (diferenciaTiempo > 10000) {
            setUsuarioActual({
              ...userData,
              docId: userDoc.id
            });
            setShowPasswordChangeModal(true);
            setInitialLoading(false);
            return; // No continuar con validaci√≥n normal
          }
        }

        // Continuar con validaci√≥n normal si no requiere cambio
        await validarSesion(user, userDoc, userData);
      } else {
        console.error("‚ùå Usuario no encontrado en Firestore");
        await signOut(auth);
        setError("Usuario no registrado en el sistema");
        setInitialLoading(false);
      }
    } catch (error) {
      console.error("‚ùå Error verificando cambio obligatorio:", error);
      setError("Error validando sesi√≥n.");
      setInitialLoading(false);
    }
  };

  // üîê FUNCI√ìN PARA MANEJAR CAMBIO OBLIGATORIO DE CONTRASE√ëA
  const handleCambioObligatorio = async (e) => {
    e.preventDefault();
    
    if (nuevaPassword !== confirmarPassword) {
      setError('Las contrase√±as no coinciden');
      return;
    }
    
    // üîê VALIDACIONES DE SEGURIDAD ESTRICTAS
    if (nuevaPassword.length < 8) {
      setError('La contrase√±a debe tener al menos 8 caracteres');
      return;
    }
    
    const regexMayuscula = /[A-Z]/;
    const regexMinuscula = /[a-z]/;
    const regexNumero = /[0-9]/;
    const regexEspecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]+/;
    
    if (!regexMayuscula.test(nuevaPassword) || 
        !regexMinuscula.test(nuevaPassword) || 
        !regexNumero.test(nuevaPassword) || 
        !regexEspecial.test(nuevaPassword)) {
      setError('La contrase√±a debe incluir: may√∫sculas, min√∫sculas, n√∫meros y caracteres especiales (!@#$%^&*)');
      return;
    }
    
    setChangingPassword(true);
    setError('');
    
    try {
      const user = auth.currentUser;
      
      // üîê ACTUALIZAR CONTRASE√ëA EN FIREBASE AUTH
      await updatePassword(user, nuevaPassword);
      
      // üîê ACTUALIZAR ESTADO EN FIRESTORE
      await updateDoc(doc(db, 'usuarios', usuarioActual.docId), {
        requiereCambioPassword: false,
        fechaCambioClave: new Date().toISOString(),
        fechaActualizacion: new Date().toISOString()
      });
      
      // üîê REGISTRAR ACCI√ìN
      await registrarLog(
        usuarioActual.docId,
        user.email,
        'cambio_password_obligatorio',
        'Cambio obligatorio de contrase√±a completado exitosamente',
        'seguridad',
        'exitoso'
      );
      
      console.log('‚úÖ Contrase√±a cambiada exitosamente');
      
      // Limpiar estados del modal
      setShowPasswordChangeModal(false);
      setNuevaPassword('');
      setConfirmarPassword('');
      setUsuarioActual(null);
      
      // Continuar con validaci√≥n normal
      const q = query(collection(db, 'usuarios'), where('email', '==', user.email));
      const querySnapshot = await getDocs(q);
      if (!querySnapshot.empty) {
        const userDoc = querySnapshot.docs[0];
        const userData = { ...userDoc.data(), requiereCambioPassword: false };
        await validarSesion(user, userDoc, userData);
      }
      
    } catch (error) {
      console.error('‚ùå Error al cambiar contrase√±a:', error);
      setError('Error al cambiar contrase√±a. Int√©ntelo nuevamente.');
      
      await registrarLog(
        usuarioActual?.docId || 'sistema',
        auth.currentUser?.email || 'unknown',
        'cambio_password_obligatorio',
        `Error al cambiar contrase√±a: ${error.message}`,
        'seguridad',
        'fallido'
      );
    } finally {
      setChangingPassword(false);
    }
  };

  const validarSesion = async (user, userDoc = null, userData = null) => {
    try {
      // Si no se proporcionan los datos, buscarlos
      if (!userDoc || !userData) {
        const q = query(collection(db, 'usuarios'), where('email', '==', user.email));
        const querySnapshot = await getDocs(q);
        
        if (!querySnapshot.empty) {
          userDoc = querySnapshot.docs[0];
          userData = userDoc.data();
        } else {
          throw new Error('Usuario no encontrado en Firestore');
        }
      }

      console.log('üîç Validando sesi√≥n para:', userData);

      // üîê VERIFICAR SI LA CUENTA EST√Å ACTIVA
      if (userData.activo === false || userData.active === false) {
        console.error("‚ùå Cuenta deshabilitada.");
        setError("Tu cuenta est√° deshabilitada. Contacta al administrador.");

        await registrarLog(
          userDoc.id,
          user.email,
          'intento_login',
          'Intento de inicio de sesi√≥n con cuenta deshabilitada',
          'autenticacion',
          'fallido'
        );

        await signOut(auth);
        setInitialLoading(false);
        return;
      }

      // üîê REGISTRAR ACCESO EXITOSO
      await registrarLog(
        userDoc.id, 
        user.email,
        'inicio_sesion',
        'Inicio de sesi√≥n exitoso',
        'autenticacion',
        'exitoso'
      );

      // üîê ACTUALIZAR √öLTIMO ACCESO
      await updateDoc(doc(db, 'usuarios', userDoc.id), {
        ultimoAcceso: new Date().toISOString()
      });

      // Establecer rol de usuario
      const userRole = userData.role || userData.rol;
      localStorage.setItem('userRole', userRole);
      setUserRole(userRole);
      
      console.log('‚úÖ Sesi√≥n validada exitosamente. Rol:', userRole);
      
      // üîê REDIRECCIONAR SEG√öN ROL
      if (userRole === 'admin' || userRole === 'administrador') {
        navigate('/gestion-usuarios');
      } else if (userRole === 'receptionist' || userRole === 'operador') {
        navigate('/gestion-clientes');
      } else {
        navigate('/gestion-usuarios'); // Default fallback
      }

    } catch (error) {
      console.error("‚ùå Error validando sesi√≥n:", error);
      setError("Error validando sesi√≥n.");
      
      if (user) {
        await registrarLog(
          user.uid,
          user.email,
          'validar_sesion',
          `Error en validaci√≥n: ${error.message}`,
          'autenticacion',
          'fallido'
        );
      }
      
      await signOut(auth);
    } finally {
      setInitialLoading(false);
    }
  };

  const handleIngresarClick = async () => {
    try {
      if (loginLoading || initialLoading) return;
      setError('');
      setLoginLoading(true);

      const emailTrimmed = email.trim();
      
      // üîê VALIDACIONES DE ENTRADA MEJORADAS
      if (!emailTrimmed || !emailTrimmed.includes('@')) {
        setError('Por favor, ingresa un correo electr√≥nico v√°lido');
        setLoginLoading(false);
        return;
      }

      if (!password || password.length < 6) {
        setError('La contrase√±a debe tener al menos 6 caracteres');
        setLoginLoading(false);
        return;
      }

      console.log('üîê Intentando autenticaci√≥n para:', emailTrimmed);

      // üîê AUTENTICACI√ìN CON FIREBASE
      const userCredential = await signInWithEmailAndPassword(auth, emailTrimmed, password);
      const user = userCredential.user;

      console.log('‚úÖ Usuario autenticado exitosamente:', user.email);
      
      // La verificaci√≥n de cambio obligatorio se maneja en el useEffect
      // a trav√©s de onAuthStateChanged

    } catch (error) {
      console.error("‚ùå Error en login:", error);
      
      await registrarLog(
        'sistema',
        email.trim(),
        'intento_login',
        `Credenciales incorrectas: ${error.message}`,
        'autenticacion',
        'fallido'
      );

      // üîê MENSAJES DE ERROR ESPEC√çFICOS
      let errorMessage = 'Credenciales incorrectas';
      if (error.code === 'auth/user-not-found') {
        errorMessage = 'No existe una cuenta con este correo electr√≥nico';
      } else if (error.code === 'auth/wrong-password') {
        errorMessage = 'Contrase√±a incorrecta';
      } else if (error.code === 'auth/too-many-requests') {
        errorMessage = 'Demasiados intentos fallidos. Int√©ntalo m√°s tarde';
      } else if (error.code === 'auth/user-disabled') {
        errorMessage = 'Tu cuenta est√° deshabilitada. Contacta al administrador';
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = 'El formato del correo electr√≥nico no es v√°lido';
      } else if (error.code === 'auth/network-request-failed') {
        errorMessage = 'Error de conexi√≥n. Verifica tu internet';
      }

      setError(errorMessage);
      setLoginLoading(false);
    }
  };

  // Manejar tecla Enter
  const handleKeyPress = (e) => {
    if (e.key === 'Enter') {
      handleIngresarClick();
    }
  };

  // üîê RENDERIZAR MODAL DE CAMBIO OBLIGATORIO DE CONTRASE√ëA
  const renderModalCambioPassword = () => {
    return (
      <div className="modal-overlay">
        <div className="modal-container">
          <div className="modal-header">
            <h3>üîê Cambio de Contrase√±a Obligatorio</h3>
          </div>
          
          <form onSubmit={handleCambioObligatorio} className="modal-body">
            <div className="warning-message">
              <p><strong>Por seguridad, debe cambiar su contrase√±a en el primer inicio de sesi√≥n.</strong></p>
            </div>
            
            <div className="form-group">
              <label htmlFor="nuevaPassword">Nueva Contrase√±a *</label>
              <input 
                type="password"
                id="nuevaPassword"
                value={nuevaPassword}
                onChange={(e) => setNuevaPassword(e.target.value)}
                required
                minLength={8}
                placeholder="Ingrese su nueva contrase√±a"
                disabled={changingPassword}
              />
            </div>
            
            <div className="form-group">
              <label htmlFor="confirmarPassword">Confirmar Nueva Contrase√±a *</label>
              <input 
                type="password"
                id="confirmarPassword"
                value={confirmarPassword}
                onChange={(e) => setConfirmarPassword(e.target.value)}
                required
                minLength={8}
                placeholder="Confirme su nueva contrase√±a"
                disabled={changingPassword}
              />
            </div>
            
            <div className="password-requirements">
              <h4>Requisitos de seguridad:</h4>
              <ul>
                <li>‚úì M√≠nimo 8 caracteres</li>
                <li>‚úì Al menos una may√∫scula (A-Z)</li>
                <li>‚úì Al menos una min√∫scula (a-z)</li>
                <li>‚úì Al menos un n√∫mero (0-9)</li>
                <li>‚úì Al menos un car√°cter especial (!@#$%^&*)</li>
              </ul>
            </div>
            
            {error && <div className="error-message">{error}</div>}
            
            <div className="modal-footer">
              <button 
                type="submit" 
                className="change-password-btn" 
                disabled={changingPassword}
              >
                {changingPassword ? 'üîÑ Cambiando...' : 'üîê Cambiar Contrase√±a'}
              </button>
            </div>
          </form>
        </div>
      </div>
    );
  };

  // üé® RENDERIZAR PANTALLA DE BIENVENIDA
  if (!showLogin && !initialLoading) {
    return (
      <div className="bienvenida-login-background">
        <div className="bienvenida-login-container">
          <div className="logo-container">
            <img 
              src="https://i.ibb.co/xtN8mjLv/logo.png" 
              alt="Logo Sistema" 
              className="logo" 
            />
          </div>
          <h1 className="welcome-text">Bienvenido al Sistema</h1>
          <p className="welcome-subtitle">Gesti√≥n Segura de Personal y Clientes</p>
          <button 
            className="bienvenida-login-button" 
            onClick={() => setShowLogin(true)}
          >
            üîê Iniciar Sesi√≥n
          </button>
        </div>
      </div>
    );
  }

  // üîê RENDERIZAR PANTALLA DE LOGIN
  return (
    <div className="login-container">
      {/* MODAL DE CAMBIO OBLIGATORIO DE CONTRASE√ëA */}
      {showPasswordChangeModal && renderModalCambioPassword()}
      
      <div className="login-card">
        <div className="login-header">
          <img 
            src="https://i.ibb.co/xtN8mjLv/logo.png" 
            alt="Logo" 
            className="login-image" 
          />
          <h2>üîê Acceso Seguro</h2>
          <p className="login-subtitle">Ingrese sus credenciales corporativas</p>
        </div>
        
        <div className="login-form">
          <div className="input-group">
            <label htmlFor="email">üìß Correo Electr√≥nico</label>
            <input
              type="email"
              id="email"
              placeholder="usuario@dominio.com"
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              onKeyPress={handleKeyPress}
              disabled={initialLoading || loginLoading}
              autoComplete="email"
            />
          </div>
          
          <div className="input-group">
            <label htmlFor="password">üîë Contrase√±a</label>
            <input
              type="password"
              id="password"
              placeholder="Ingrese su contrase√±a"
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              onKeyPress={handleKeyPress}
              disabled={initialLoading || loginLoading}
              autoComplete="current-password"
            />
          </div>
          
          <button 
            className="login-button"
            onClick={handleIngresarClick} 
            disabled={loginLoading || initialLoading}
          >
            {loginLoading ? 'üîÑ Iniciando sesi√≥n...' : 
             initialLoading ? '‚è≥ Cargando...' : 
             'üöÄ Ingresar'}
          </button>
          
          {error && (
            <div className="error-message">
              ‚ö†Ô∏è {error}
            </div>
          )}
          
          <div className="login-footer">
            <button 
              className="back-button"
              onClick={() => setShowLogin(false)}
              disabled={loginLoading || initialLoading}
            >
              ‚Üê Volver
            </button>
          </div>
        </div>
      </div>
      
      {/* INDICADOR DE SEGURIDAD */}
      <div className="security-indicator">
        <p>üîí Conexi√≥n segura protegida</p>
      </div>
    </div>
  );
}

export default RegLogin;